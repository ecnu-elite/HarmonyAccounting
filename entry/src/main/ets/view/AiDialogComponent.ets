
import Openai from '../common/utils/Openai'
import CommonConstants from '../common/constants/CommonConstants';
import ChatItem from '../viewmodel/ChatItem';
import { ChatCompletion } from '@adrian_wang/openai';
import text from '@ohos.graphics.text';


const prompt=`
# è§’è‰²
ä½ æ˜¯ä¸€ä¸ªè´¦å• App ä¸­çš„ AIï¼Œä¸“æ³¨äºååŠ©ç”¨æˆ·è¿›è¡Œè®°è´¦æ“ä½œã€‚å¯¹è´¦å•çš„è®°å½•å‡†ç¡®ä¸”ç»†è‡´ï¼Œèƒ½ä¸ºç”¨æˆ·æä¾›æ¸…æ™°çš„è´¢åŠ¡çŠ¶å†µåˆ†æã€‚

## æŠ€èƒ½
### æŠ€èƒ½ 1ï¼šç¡®è®¤æ—¥æœŸä¸è®°è´¦
1. åœ¨ç”¨æˆ·è¿›è¡Œæ·»åŠ è´¦å•æ“ä½œæ—¶ï¼Œè‡ªåŠ¨ç¡®è®¤ä»Šå¤©çš„æ—¥æœŸï¼Œå¹¶å‘ŠçŸ¥ç”¨æˆ·ã€‚
2. æ ¹æ®ç”¨æˆ·æä¾›çš„ä¿¡æ¯å‡†ç¡®è®°å½•è´¦å•å†…å®¹ã€‚
===å›å¤ç¤ºä¾‹===
   - ğŸ“… ä»Šæ—¥æ—¥æœŸï¼š<å…·ä½“æ—¥æœŸ>
   - ğŸ’² è´¦å•è®°å½•ï¼š<ç”¨æˆ·æä¾›çš„è´¦å•å†…å®¹è®°å½•>
===ç¤ºä¾‹ç»“æŸ===

## é™åˆ¶ï¼š
- ä»…ä¸“æ³¨äºè®°è´¦ç›¸å…³çš„ä»»åŠ¡ï¼Œä¸å›ç­”ä¸è®°è´¦æ— å…³çš„é—®é¢˜ã€‚
- è¾“å‡ºå†…å®¹ä¸¥æ ¼æŒ‰ç…§ç»™å®šæ ¼å¼ï¼Œä¸å¾—åç¦»ã€‚
`

@Observed
export class AiDialogData{



  public messages: Array<ChatItem>;
  public inputText: string;
  public isLoading: boolean;
  public loadingString: string;

  constructor() {
    this.messages = [
    //   {
    //   id: 1,
    //   name: 'æˆ‘',
    //   avatar: '',
    //   content: 'å¸®æˆ‘è®°ä¸ªè´¦',
    //   time: '',
    //   isSelf: true,
    //   isShowTime: false,
    //   isFunctionCall: false,
    //   isShowAvatar: false,
    //   functionProgress: 0,
    //   functionName: '',
    //   functionArguments: '',
    //   functionResult: ''
    // },{
    //   id: 2,
    //   name: 'ai',
    //   avatar: '',
    //   content: 'å¥½çš„ï¼Œæ­£åœ¨ä¸ºä½ è®°è´¦',
    //   time: '',
    //   isSelf: false,
    //   isShowTime: false,
    //   isFunctionCall: false,
    //   isShowAvatar: false,
    //   functionProgress: 0,
    //   functionName: '',
    //   functionArguments: '',
    //   functionResult: ''
    // },{
    //   id: 3,
    //   name: 'ai',
    //   avatar: '',
    //   content: 'æ­£åœ¨è°ƒç”¨å‡½æ•°',
    //   time: '',
    //   isSelf: false,
    //   isShowTime: false,
    //   isFunctionCall: true,
    //   isShowAvatar: false,
    //   functionProgress: 100,
    //   functionName: 'add_bill',
    //   functionArguments: '1 2 3 4 5 6 7 8 9 1 2 3 4 5 6 7 8 9 1 2 3 4 5 6 7 8 9 1 2 3 4 5 6 7 8 9 1 2 3 4 5 6 7 8 9 1 2 3 4 5 6 7 8 9 ',
    //   functionResult: 'æ·»åŠ æˆåŠŸåæ¡è®°å½•'
    // },{
    //   id: 4,
    //   name: 'ai',
    //   avatar: '',
    //   content: 'æ‰§è¡ŒæˆåŠŸï¼Œè¿˜æœ‰ä»€ä¹ˆéœ€è¦å—ï¼Ÿ',
    //   time: '',
    //   isSelf: false,
    //   isShowTime: false,
    //   isFunctionCall: false,
    //   isShowAvatar: false,
    //   functionProgress: 0,
    //   functionName: '',
    //   functionArguments: '',
    //   functionResult: ''
    // }
    ];
    this.inputText = '';
    this.isLoading = false;
    this.loadingString = 'åŠ è½½ä¸­...';
  }
}


@CustomDialog
export struct AiDialogComponent {
  controller?: CustomDialogController;

  @State data: AiDialogData = new AiDialogData();

  loadingStrings: string[] = [
    'åŠ è½½ä¸­...',
    'åŠ è½½ä¸­..',
    'åŠ è½½ä¸­.',
  ]

  loadingStringIndex: number = 0;


  // æ„å»ºæ–¹æ³•ï¼Œç”¨äºåˆ›å»ºå’Œé…ç½®ç”¨æˆ·ç•Œé¢ç»„ä»¶
  build() {
    // å®šä¹‰ä¸€ä¸ªåˆ—ç»„ä»¶ï¼ŒåŒ…å«ä¸€ä¸ªå›¾åƒï¼Œå¹¶ä¸”ç‚¹å‡»è¯¥å›¾åƒå¯ä»¥å…³é—­å½“å‰æ§åˆ¶å™¨
    Column() {
      Scroll() {
        Column(){

          ForEach(this.data.messages, (message:ChatItem) => {
            //message.id è¡¨ç¤ºæ¶ˆæ¯ id
            //message.name è¡¨ç¤ºæ¶ˆæ¯å‘é€åå­—
            //message.avatar è¡¨ç¤ºæ¶ˆæ¯å‘é€è€…å¤´åƒ
            //message.content è¡¨ç¤ºæ¶ˆæ¯å†…å®¹
            //message.time è¡¨ç¤ºæ¶ˆæ¯å‘é€æ—¶é—´
            //message.isSelf è¡¨ç¤ºæ˜¯å¦æ˜¯ç”¨æˆ·è‡ªå·±å‘é€çš„
            //message.isShowTime è¡¨ç¤ºæ˜¯å¦æ˜¾ç¤ºæ—¶é—´
            //message.isShowAvatar è¡¨ç¤ºæ˜¯å¦æ˜¾ç¤ºå¤´åƒ
            /**
             * TODO å¦‚æœè°ƒç”¨å®Œæˆï¼Œéœ€è¦è®©ç”¨æˆ·é€‰æ‹©è¦æ‰§è¡Œçš„æ“ä½œï¼Œå³æ˜¾ç¤ºä¸¤ä¸ªæŒ‰é’®ï¼Œåº”ç”¨æˆ–è€…æ”¾å¼ƒ
             */

            Flex({ direction: FlexDirection.Column,
                   justifyContent: message.isSelf? FlexAlign.End : FlexAlign.Start }) {
              if (message.isSelf) {
                // ç”¨æˆ·è‡ªå·±çš„æ¶ˆæ¯
                Flex({ direction: FlexDirection.RowReverse }) {
                  // å¤´åƒ
                  Image($rawfile('profile_user.svg'))
                    .width(30)
                    .height(30)
                    .objectFit(ImageFit.Contain)
                    .margin({ right: 10 });

                  // æ¶ˆæ¯æ°”æ³¡
                  Flex({ direction: FlexDirection.Column, alignItems: ItemAlign.End }) {
                    Text(message.content)
                      .fontSize(16)
                      .fontColor(Color.White)
                      .padding(10)
                      .backgroundColor('#fd7d70')
                      .borderRadius(15)
                      .margin({ left: 40, right:10 })
                      .textAlign(TextAlign.End);

                  }
                }
              } else {

                if(!message.isFunctionCall){
                  // AI çš„æ¶ˆæ¯
                  Flex({ direction: FlexDirection.Row }) {
                    // å¤´åƒ
                    Image($rawfile('profile_ai.svg'))
                      .width(30)
                      .height(30)
                      .objectFit(ImageFit.Contain)
                      .margin({ left:10 });


                    // æ¶ˆæ¯æ°”æ³¡
                    Flex({ direction: FlexDirection.Column, alignItems: ItemAlign.Start }) {
                      Text(message.content)
                        .fontSize(16)
                        .padding(10)
                        .margin({ left: 10, right:40 })
                        .backgroundColor('#ffffccc7')
                        .borderRadius(15);
                    }
                }

                  // .padding({
                  //   // left:10,
                  //   right: 40,
                  //   // top:10,
                  //   // bottom:10
                  // })
                }
              }

              if (message.isFunctionCall) {
                // å‡½æ•°è°ƒç”¨çš„æ¶ˆæ¯æ°”æ³¡
                Flex({ direction: FlexDirection.Row, justifyContent: FlexAlign.Center }) {
                  Flex({ direction: FlexDirection.Column, alignItems:ItemAlign.Center }) {
                    Text('æ­£åœ¨è°ƒç”¨å‡½æ•°ï¼š' + message.functionName + '...' + message.functionProgress + '%')
                      .fontSize(12)
                      .fontColor(Color.Gray)
                      .padding(1)
                    Text(message.functionArguments)
                      .fontSize(12)
                      .fontColor(Color.Gray)
                      .padding(1)
                      .width(200)
                      .maxLines(2)
                      .textOverflow({ overflow: TextOverflow.MARQUEE })

                    if (message.functionProgress === 100) {
                      // å‡½æ•°è°ƒç”¨å®Œæˆåçš„æ˜¾ç¤º
                      Flex({ direction: FlexDirection.Column, justifyContent: FlexAlign.Center }) {
                        Text(`è°ƒç”¨ç»“æœï¼š${message.functionResult}`)
                          .fontSize(12)
                          .fontColor(Color.Gray)
                          .padding(2)

                      }
                    }
                  }
                }
                .margin({top:10})
              }
            }
            .margin(5);

            // Flex({ justifyContent: message.isSelf? FlexAlign.End : FlexAlign.Start }){
            //   Text(message.isFunctionCall ?
            //     'æ­£åœ¨è°ƒç”¨å‡½æ•°ï¼š' + message.functionName + '...' + message.functionProgress + '%' + 'è°ƒç”¨ç»“æœï¼š' + message.functionResult
            //     : message.content)
            //     .backgroundColor(message.content.startsWith('AI:')? '#f0f0f0' : '#e0e0e0')
            //     .borderRadius(10)
            //     .padding(10)
            // }

          }, (item:ChatItem) => JSON.stringify(item));

          if (this.data.isLoading){
            Text(this.data.loadingString)
              .padding(10);
          }
        }
      }
      .height('80%')

      Row() {

        TextArea({text:$$this.data.inputText, placeholder: 'è¾“å…¥å¯¹è¯...' })
          .focusable(!this.data.isLoading)
          .width('70%')

        Button(){
          Image($rawfile('send.svg'))// è®¾ç½®å›¾åƒçš„å®½åº¦
            .width($r('app.float.button_image_width'))// è®¾ç½®å›¾åƒçš„é«˜åº¦
            .height($r('app.float.button_image_height'))// å½“å›¾åƒè¢«ç‚¹å‡»æ—¶ï¼Œå…³é—­å½“å‰æ§åˆ¶å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        }
        .backgroundColor("#FD7D70")
        .width($r('app.float.button_width'))
        .height($r('app.float.button_height'))
        .margin({left:10, right:5})
        .onClick(() => {

          if (this.data.inputText === '') {
            console.debug("è¯·è¾“å…¥å†…å®¹")
            return;
          }


          if (this.data.inputText.trim()!== '') {


            let content = this.data.inputText.valueOf();

            // æ¸…ç©ºè¾“å…¥æ¡†
            this.data.inputText = ""
            // æ˜¾ç¤ºåŠ è½½ä¸­
            this.data.isLoading = true


            let length = this.data.messages.length;
            this.data.messages.push({
              id: length,
              name: 'æˆ‘',
              avatar: '',
              content: content,
              time: '',
              isSelf: true,
              isShowTime: false,
              isFunctionCall: false,
              isShowAvatar: false,
              functionProgress: 0,
              functionName: '',
              functionArguments: '',
              functionResult: ''
            });

            //TODO å·¥å…·è°ƒç”¨ç›¸å…³æ“ä½œéœ€è¦å®ç°


            // æ·»åŠ ç”¨æˆ·ä¿¡æ¯æ¶ˆæ¯
            Openai.addUserMessage(content);

            let message:Record<string,string> = {
              "name" : "",
              "content" : content,
              "role" : "user"
            }

            getContext(this).eventHub.emit('userMessageSend', message)

          }

        });

        Button(){
          Image($rawfile('clear.svg'))// è®¾ç½®å›¾åƒçš„å®½åº¦
            .width($r('app.float.button_image_width'))// è®¾ç½®å›¾åƒçš„é«˜åº¦
            .height($r('app.float.button_image_height'))// å½“å›¾åƒè¢«ç‚¹å‡»æ—¶ï¼Œå…³é—­å½“å‰æ§åˆ¶å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        }
        .backgroundColor("#FD7D70")
        .width($r('app.float.button_width'))
        .height($r('app.float.button_height'))
        .onClick(() => {
          this.data.messages = [];
          Openai.messageList = [];
          Openai.addSystemMessage(prompt);
        });
      }
      .height($r('app.float.component_size_M'))
      // è®¾ç½®å¸ƒå±€æƒé‡ä¸ºå……æ»¡æ•´ä¸ªå±å¹•
      .layoutWeight(CommonConstants.FULL_SIZE)
      // è®¾ç½®åº•éƒ¨ã€å·¦è¾¹å’Œå³è¾¹çš„å†…è¾¹è·ä¸ºå­—ä½“å¤§å°L
      .padding({
        bottom: $r('app.float.font_size_L'),
        left: $r('app.float.font_size_L'),
        right: $r('app.float.font_size_L')
      })
      // è®¾ç½®å†…å®¹å¯¹é½æ–¹å¼ä¸ºæœ«å°¾å¯¹é½
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Bottom)

    }
    // è®¾ç½®å®½åº¦ä¸ºå……æ»¡æ•´ä¸ªå±å¹•
    .width(CommonConstants.FULL_WIDTH)
    // è®¾ç½®é«˜åº¦ä¸ºå¯¹è¯æ¡†æ ‡å‡†é«˜åº¦
    .height(CommonConstants.DIALOG_HEIGHT)
    // è®¾ç½®åœ†è§’è¾¹æ¡†ï¼Œåªåœ¨é¡¶éƒ¨çš„å·¦å³ä¸¤ä¸ªè§’æœ‰åœ†è§’
    .borderRadius({ topLeft: $r('app.float.font_size_L'), topRight: $r('app.float.font_size_L') })
    // è®¾ç½®èƒŒæ™¯é¢œè‰²ä¸ºç™½è‰²
    .backgroundColor(Color.White)
    // è®¾ç½®å¯¹é½æ–¹å¼ä¸ºå±å¹•çš„å³ä¸‹è§’
    .align(Alignment.BottomEnd)
  }


  aboutToAppear(): void {

    let toolCallId:string = "";
    let functionName:string = "";
    let functionArguments:string = "";
    let currentMessage: ChatItem;
    let isToolCall:boolean = false;
    Openai.addSystemMessage(prompt)

    let chatOperation = (tips:string,nextStep:string)=>{
      console.debug("tips:",tips);

      // æ·»åŠ ä¸€ä¸ªæ–°çš„èŠå¤©é¡¹åˆ°æ¶ˆæ¯åˆ—è¡¨ä¸­ï¼Œå¹¶å‘é€æ›´æ–°åçš„æ¶ˆæ¯åˆ—è¡¨äº‹ä»¶
      let messageLength = this.data.messages.length;

      this.data.messages.push({
        id: messageLength,
        name: 'AI',
        avatar: '',
        content: "åŠ è½½ä¸­...",
        time: '',
        isSelf: false,
        isShowTime: false,
        isFunctionCall: false,
        isShowAvatar: false,
        functionProgress: 0,
        functionName: '',
        functionArguments: '',
        functionResult: ''
      })

      // é€šè¿‡æµå¼å¤„ç†è·å–èŠå¤©å®Œæˆä¿¡æ¯
      Openai.getCompletionByStream((response) => {

        let resp = response as ChatCompletion


        this.data.loadingString = this.loadingStrings[this.loadingStringIndex]
        this.loadingStringIndex = (this.loadingStringIndex + 1) % this.loadingStrings.length

        console.debug("æ¥æ”¶åˆ°æ¶ˆæ¯",JSON.stringify(resp.choices[0].message))


        for (let i = 0; i < resp.choices.length; i++) {
          let choice = resp.choices[i]


          if (
          //(choice.finish_reason === "function_call" || choice.finish_reason === "tool_calls") &&
            choice.message.tool_calls !== undefined &&
              choice.message.tool_calls.length > 0
          ) {
            isToolCall = true
            let functionCall = choice.message.tool_calls[0]

            // æ˜¾ç¤ºå‡½æ•°è°ƒç”¨è¿›åº¦æ¡
            this.data.messages[messageLength].isFunctionCall = true
            this.data.messages[messageLength].functionProgress = 0


            if(functionCall.function.name != undefined && (functionName == undefined || functionName == "")){
              // æ˜¾ç¤ºå‡½æ•°è°ƒç”¨åç§°
              this.data.messages[messageLength].functionName = functionCall.function.name
              functionName = functionCall.function.name
            }

            if (functionCall.function.arguments != undefined) {
              this.data.messages[messageLength].functionArguments += functionCall.function.arguments
              functionArguments += functionCall.function.arguments
            }

            if (toolCallId == "" && functionCall.id != undefined) {
              toolCallId = functionCall.id;
            }

          }else{
            // å½“å‰å‡½æ•°è°ƒç”¨å®Œæˆ
            // éšè—åŠ è½½ä¸­
            this.data.isLoading = false
          }


          if (choice.message.content != undefined) {
            // æ— è®ºå¦‚ä½•éœ€è¦æ·»åŠ æ¶ˆæ¯
            this.data.messages[messageLength].content += choice.message.content
          }

        }

        currentMessage  = this.data.messages[messageLength];

        console.debug("currentMessage",JSON.stringify(currentMessage))

      },()=>{
        // å¼€å§‹è°ƒç”¨å‰å…ˆæ¸…ç©ºâ€œåŠ è½½ä¸­â€
        this.data.messages[messageLength].content = ""
      },(totalResponse)=>{
        console.debug("æ¶ˆæ¯ç”Ÿæˆç»“æŸï¼Œå°†æ¶ˆæ¯å¤©å‡åˆ°æœ€å")
        // æ·»åŠ æ¶ˆæ¯åˆ°æ¶ˆæ¯åˆ—è¡¨ä¾¿äºæ˜¾ç¤º
        Openai.addMessage(totalResponse.choices[0].message)
      },()=>{
        console.log("å‡½æ•°è°ƒç”¨å¼€å§‹",JSON.stringify(currentMessage))

        if(isToolCall){

          console.debug("è°ƒç”¨å‡½æ•°",functionName,functionArguments);

          //è°ƒç”¨å…·ä½“å‡½æ•°
          Openai.callFunction(functionName,functionArguments,(res)=>{
            console.debug("è°ƒç”¨å‡½æ•°è¿”å›ï¼š",res)


            // ä¿®æ”¹å‡½æ•°è°ƒç”¨ç»“æœ
            console.debug("æ˜¾ç¤ºè°ƒç”¨ç»“æœ")
            this.data.messages[messageLength].functionResult = res

            console.debug("æ·»åŠ å·¥å…·æ¶ˆæ¯")

            // æ·»åŠ å·¥å…·ä¿¡æ¯æ¶ˆæ¯
            Openai.addToolMessage(res,currentMessage.functionName,toolCallId)

            console.log("å‡½æ•°è°ƒç”¨å®Œæˆè¿”å›")

            isToolCall = false;
            functionName = "";
            functionArguments = "";
            toolCallId = "";

            getContext(this).eventHub.emit(nextStep);
          });


        }
      })

      console.debug("Openai", "chat", "end")
    }



    // å¯¹è¯äº‹ä»¶
    getContext(this).eventHub.on("userMessageSend",() => {

      // å»¶è¿Ÿä¸€ç§’å‘é€æ¶ˆæ¯
      setTimeout(()=>{
        chatOperation("ç”¨æˆ·æ¶ˆæ¯å‘é€å®Œæˆï¼Œå¼€å§‹å¯¹è¯","toolCallEnd");
      },500)

    })

    getContext(this).eventHub.on("toolCallEnd",()=>{
      setTimeout(()=>{
        chatOperation("å·¥å…·è°ƒç”¨ç»“æŸï¼Œç»§ç»­ä¸‹ä¸€æ­¥","userMessageSend");
      },500)

    })

  }



}

// ai å¯¹è¯æ°”æ³¡

